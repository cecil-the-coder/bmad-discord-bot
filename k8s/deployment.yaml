apiVersion: apps/v1
kind: Deployment
metadata:
  name: bmad-discord-bot
  namespace: bmad-bot
  labels:
    app: bmad-discord-bot
    version: v1.0
    component: bot
  annotations:
    # Checkov skips for deployment requirements
    checkov.io/skip1: CKV_K8S_35=Application architecture requires secrets as environment variables
    checkov.io/skip2: CKV_K8S_14=Using latest tag for automated deployments from main branch
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: bmad-discord-bot
  template:
    metadata:
      labels:
        app: bmad-discord-bot
        version: v1.0
        component: bot
      annotations:
        prometheus.io/scrape: "false"
        co.elastic.logs/enabled: "true"
        # Checkov skips for deployment requirements
        checkov.io/skip: CKV_K8S_35=Application architecture requires secrets as environment variables,CKV_K8S_14=Using latest tag for automated deployments from main branch
    spec:
      serviceAccountName: bmad-bot-sa
      automountServiceAccountToken: false
      securityContext:
        fsGroup: 10001
        runAsGroup: 10001
        runAsUser: 10001
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: bmad-discord-bot
        image: ghcr.io/cecil-the-coder/bmad-discord-bot/bmad-discord-bot:latest
        imagePullPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 10001
          runAsGroup: 10001
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
            ephemeral-storage: "1Gi"
          limits:
            memory: "512Mi"
            cpu: "500m"
            ephemeral-storage: "2Gi"
        env:
        - name: BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: bmad-bot-secrets
              key: BOT_TOKEN
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: bmad-bot-secrets
              key: MYSQL_PASSWORD
        - name: MYSQL_USERNAME
          valueFrom:
            secretKeyRef:
              name: bmad-bot-secrets
              key: MYSQL_USERNAME
        - name: MYSQL_HOST
          valueFrom:
            secretKeyRef:
              name: bmad-bot-secrets
              key: MYSQL_HOST
        - name: OLLAMA_HOST
          valueFrom:
            secretKeyRef:
              name: bmad-bot-secrets
              key: OLLAMA_HOST
        envFrom:
        - configMapRef:
            name: bmad-bot-config
        # No ports needed - bot uses Discord WebSocket API and command-based health checks
        livenessProbe:
          exec:
            command:
            - /app/main
            - --health-check
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          successThreshold: 1
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - /app/main
            - --health-check
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3
        startupProbe:
          exec:
            command:
            - /app/main
            - --health-check
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 12
        volumeMounts:
        - name: secrets-volume
          mountPath: /app/secrets
          readOnly: true
        - name: logs-volume
          mountPath: /app/logs
        - name: temp-volume
          mountPath: /tmp
      volumes:
      - name: logs-volume
        emptyDir:
          sizeLimit: 1Gi
      - name: temp-volume
        emptyDir:
          sizeLimit: 100Mi
      - name: secrets-volume
        secret:
          secretName: bmad-bot-secrets
          defaultMode: 0400
      terminationGracePeriodSeconds: 30
      restartPolicy: Always
      nodeSelector:
        kubernetes.io/os: linux